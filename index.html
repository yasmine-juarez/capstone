<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>Choropleth Map with ArcGIS Services</title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
    <script src="https://js.arcgis.com/4.29/"></script>
    <style>
        html, body, #viewDiv {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }
        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 10px;
            z-index: 10;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div id="controls">
        <label for="yearSlider">Select Year:</label>
        <input type="range" id="yearSlider" min="1960" max="2021" value="2000" step="1"/>
        <span id="yearLabel">2010</span>
        <br/><label for="featureSelect">Choose Feature:</label>
        <select id="featureSelect">
            <option value="e_fh_status">e_fh_status</option>
            <option value="v2x_mpi">v2x_mpi</option>
            <option value="e_lexical_index">e_lexical_index</option>
            <option value="v2x_libdem">v2x_libdem</option>
            <option value="v2xcl_rol">v2xcl_rol</option>
            <option value="v2x_egaldem">v2x_egaldem</option>
            <option value="e_fh_pr">e_fh_pr</option>
            <option value="e_fh_cl">e_fh_cl</option>
            <option value="pred_cl">pred_cl</option>
            <option value="pred_pr">pred_pr</option>
            <option value="pred_status">pred_status</option>
        </select>
    </div>
    <div id="viewDiv"></div>
    
    <script>
        require(["esri/Map", "esri/views/MapView", "esri/layers/FeatureLayer", "esri/widgets/Slider", "esri/widgets/Expand", "esri/rest/support/Query", "esri/widgets/Legend"], 
        function(Map, MapView, FeatureLayer, Slider, Expand, Query, Legend) {
            const map = new Map({ basemap: "topo-vector" });
            const view = new MapView({ container: "viewDiv", map: map, center: [0, 20], zoom: 3 });

            const layer = new FeatureLayer({
                url: "https://services.arcgis.com/LBbVDC0hKPAnLRpO/arcgis/rest/services/Dashboard_data/FeatureServer",
                outFields: ["*"],
                definitionExpression: "year = 2010",
                popupTemplate: {
                    title: "{Country}",
                    content: function(feature) {
                        const attributes = feature.graphic.attributes;
                        function round(value) {
                            return value !== null ? value.toFixed(4) : "N/A";
                        }
                        return `
                            <b>Year:</b> ${attributes.year} <br>
                            <b>e_fh_status:</b> ${attributes.e_fh_status} <br>
                            <b>v2x_mpi:</b> ${round(attributes.v2x_mpi)} <br>
                            <b>e_lexical_index:</b> ${attributes.e_lexical_index} <br>
                            <b>v2x_libdem:</b> ${round(attributes.v2x_libdem)} <br>
                            <b>v2xcl_rol:</b> ${round(attributes.v2xcl_rol)} <br>
                            <b>v2x_egaldem:</b> ${round(attributes.v2x_egaldem)} <br>
                            <b>e_fh_pr:</b> ${attributes.e_fh_pr} <br>
                            <b>e_fh_cl:</b> ${attributes.e_fh_cl} <br>
                            <b>pred_cl:</b> ${attributes.pred_cl} <br>
                            <b>pred_pr:</b> ${attributes.pred_pr} <br>
                            <b>pred_status:</b> ${attributes.pred_status} <br>
                        `;
                    }
                },
                alpha: 0.5
            });
            map.add(layer);

            const legend = new Legend({
                view: view,
                container: "legendDiv"
            });
            
            function updateLayer() {
            const selectedFeature = document.getElementById("featureSelect").value;
            const selectedYear = document.getElementById("yearSlider").value;
            document.getElementById("yearLabel").innerText = selectedYear;

            layer.definitionExpression = `year = ${selectedYear}`;

            const query = new Query();
            query.where = `year = ${selectedYear}`;
            query.outStatistics = [
                {
                    statisticType: "min",
                    onStatisticField: selectedFeature,
                    outStatisticFieldName: "minValue"
                },
                {
                    statisticType: "max",
                    onStatisticField: selectedFeature,
                    outStatisticFieldName: "maxValue"
                }
            ];
            query.returnGeometry = false;

            layer.queryFeatures(query).then(function (result) {
                if (result.features.length > 0) {
                    const stats = result.features[0].attributes;
                    const minValue = stats.minValue;
                    const maxValue = stats.maxValue;
                    const range = maxValue - minValue;

                    layer.renderer = {
                        type: "class-breaks",
                        alpha: 0.4,
                        field: selectedFeature,
                        classBreakInfos: [
                            { minValue: minValue, maxValue: minValue + range * 0.34, symbol: { type: "simple-fill", color: "#f7fcf5" } },
                            { minValue: minValue + range * 0.34, maxValue: minValue + range * 0.68, symbol: { type: "simple-fill", color: "#a1d99b" } },
                            { minValue: minValue + range * 0.68, maxValue: minValue + range, symbol: { type: "simple-fill", color: "#31a354" } }                        ]
                    };

                    layer.refresh();
                    legend.layerInfos = [{ layer: layer, title: "Legend" }];
                }
            });
        }
            
            document.getElementById("yearSlider").addEventListener("input", updateLayer);
            document.getElementById("featureSelect").addEventListener("change", updateLayer);
        });
    </script>
</body>
</html>
